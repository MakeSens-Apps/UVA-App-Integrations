AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Este microservicio se enfoca en integrar UVA con los otros servicios  de
  MakeSens:  1. DeviceDataAcces 2. MakeSensCloud 3. UserAPI (Connection)

  '
Globals:
  Function:
    MemorySize: 520
    Runtime: python3.9
    Architectures:
    - x86_64
    Timeout: 600
Parameters:
  SNSTopicARN:
    Type: String
    Default: arn:aws:sns:us-east-1:913045965320:RealTimeDeviceData-develop
  TopicRegion:
    Type: String
    Default: us-east-1
  MeasurementDynamoDBStreamARN:
    Type: String
    Default: arn:aws:dynamodb:us-east-1:913045965320:table/Measurement-yxrlo7mqf5bn7cuqqgssoprqam-test/stream/2024-09-29T16:19:01.140
  UVADynamoDBStreamARN:
    Type: String
    Default: arn:aws:dynamodb:us-east-1:913045965320:table/UVA-yxrlo7mqf5bn7cuqqgssoprqam-test/stream/2024-09-29T16:19:00.864
  RACIMOTableName:
    Type: String
    Default: RACIMO-yxrlo7mqf5bn7cuqqgssoprqam-test
  OrganizationName:
    Type: String
    Default: Organization-rtjffhw6ejhs7n5cxqjmxs6gzq-developer
  LocationName:
    Type: String
    Default: Location-rtjffhw6ejhs7n5cxqjmxs6gzq-developer
  CloudAppsyncUrl:
    Type: String
    Default: https://bnbto5gmgvcazhjsrxdsviyv74.appsync-api.us-east-1.amazonaws.com/graphql
  CloudApiKey:
    Type: String
    Default: da2-xxuxsrmjcrfcvetkb2wbvbe6sm
  MeasurementName:
    Type: String
    Default: Measurement-yxrlo7mqf5bn7cuqqgssoprqam-test
  UvaAppsyncUrl:
    Type: String
    Default: https://s4v4oryo25dklefaiecnoewqwy.appsync-api.us-east-1.amazonaws.com/graphql
  UvaApiKey:
    Type: String
    Default: da2-3baiqrhl3vaixczpr2g7jb376e
Resources:
  DynamoDBEventProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DynamoDBEventProcessorFunction
      Handler: dynamodb_to_sns.lambda_handler
      Events:
        DynamoDBStreamEvent:
          Type: DynamoDB
          Properties:
            Stream:
              Ref: MeasurementDynamoDBStreamARN
            StartingPosition: LATEST
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 10
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Sid: DynamoDBStreamAccess
          Effect: Allow
          Action:
          - dynamodb:ListStreams
          Resource: '*'
        - Sid: DynamoDBStreamSpecificAccess
          Effect: Allow
          Action:
          - dynamodb:GetRecords
          - dynamodb:GetShardIterator
          - dynamodb:DescribeStream
          Resource:
            Ref: MeasurementDynamoDBStreamARN
        - Sid: SNSPublishAccess
          Effect: Allow
          Action:
          - sns:Publish
          Resource:
            Ref: SNSTopicARN
      Environment:
        Variables:
          SNSTopicARN:
            Ref: SNSTopicARN
    Metadata:
      SamResourceId: DynamoDBEventProcessorFunction
  UvaToCloudFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UvaToCloudFunction
      Handler: test.lambda_handler
      Events:
        DynamoDBStreamEvent:
          Type: DynamoDB
          Properties:
            Stream:
              Ref: UVADynamoDBStreamARN
            StartingPosition: LATEST
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 10
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Sid: DynamoDBStreamAccess
          Effect: Allow
          Action:
          - dynamodb:ListStreams
          Resource: '*'
        - Sid: DynamoDBStreamSpecificAccess
          Effect: Allow
          Action:
          - dynamodb:GetRecords
          - dynamodb:GetShardIterator
          - dynamodb:DescribeStream
          Resource:
            Ref: UVADynamoDBStreamARN
        - Sid: DynamoDBReadAccess
          Effect: Allow
          Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          Resource:
          - Fn::Sub: arn:aws:dynamodb:us-east-1:913045965320:table/${RACIMOTableName}
          - Fn::Sub: arn:aws:dynamodb:us-east-1:913045965320:table/${OrganizationName}
          - Fn::Sub: arn:aws:dynamodb:us-east-1:913045965320:table/${LocationName}
      Environment:
        Variables:
          RACIMOTable:
            Ref: RACIMOTableName
          OrganizationTable:
            Ref: OrganizationName
          LocationTable:
            Ref: LocationName
          AppSyncURL:
            Ref: CloudAppsyncUrl
          ApiKey:
            Ref: CloudApiKey
    Metadata:
      SamResourceId: UvaToCloudFunction
  UVALastConnection:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UVALastConnection
      Handler: last_connection.lambda_handler
      Runtime: python3.9
      Timeout: 600
      Events:
        MyAPIGatewayEvent:
          Type: Api
          Properties:
            Path: /{id_uva}/connection
            Method: GET
            Auth:
              Authorizer: AWS_IAM
      Policies:
      - Version: '2012-10-17'
        Statement:
        - Sid: AppSyncAccess
          Effect: Allow
          Action:
          - appsync:GraphQL
          Resource: '*'
      Environment:
        Variables:
          AppSyncURL:
            Ref: UvaAppsyncUrl
          ApiKey:
            Ref: UvaApiKey
    Metadata:
      SamResourceId: UVALastConnection
